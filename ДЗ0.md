# Проблема
Коты сильно утомляются из-за того, что тратят все время на работу.
# Основная гипотеза бизнеса
Если делегировать рутину на лучших воркеров, то коты буду меньше уставать и больше делать.
# Subdomains
## Core 
### Система обработки заказов
MCF - это сервис услуг. Можно сравнить его с profi.ru. 
Основные сущности здесь - это заказ, клиент и воркер.
Без заказов ничего не будет работать.
### Рекомендательная система (отсев и мэтчинг)
**Это главное отличие от конкурентов.**
Чтобы с компанией было сложно конкурировать, эта система должна постоянно развиваться. 
Большинство инноваций будут в этом домене -> изменений здесь будет много -> эту часть нужно сделать максимально изолированной и модульной, чтобы можно было тестировать максимум гипотез.
### Система определения стоимость услуг
**Связанные US**:
[US-020], [US-050]. 
В user story стейкхолдер не акцентировал внимание на том, что это важный функционал. В первой версии вообще будет константная стоимость  [US-050]. 
Но так как MCF - это сервис услуг, клиенты хотят платить меньше денег, воркеры получать больше, то в скором времени потребуется хорошая система оценки стоимости.
В совокупности с рекомендательной системой это может стать ещё одной дифференциацией от конкурентов.

**Основные функции**:
- Подсчет стоимость и учет скидок ([US-040])
- Обработка инвойсов и хранение истории денежных операций ([US-190], [US-200], [US-230])
### Система для отбора котов
**Может быть нужно в Core, так это про отсев**.
Связана с конструктором опросов.
Это Core, так как исключительность системы в том, что в ней находятся 3% лучших воркеров-котов в мире.
Плохая система отбора -> хуже работники -> хуже качество работы -> клиенты уходят.
## Generic
### Подрядчик печенья
Печенье сами не производим, а отдаем на outsource.
Для генерации текста печенья тоже используем готовое решение - catGPT.
Все общение происходит в асинхронном формате ([US-150] через 10 минут только печенье привозят).
### Конструктор опросов
**Связанные US**:
[US-090]
На рынке много решений для создания опросов. MCF на этом не будет зарабатывать, поэтому стоит воспользоваться готовым решением. CatWebAsk, например :)
Может стать **Supporting**, если фичей готовых решений будет недостаточно для отсева котов.
### Платежка (Золотая шляпа)
**Связанные US**:
[US-200]
Подключение интеграции для оплаты.
## Supporting
### Admin Panel
**Связанные US**:
[US-021], [US-090], [US-160]
Админка могла бы быть Generic Subdomain, но все же в ней многое будет завязано на сущностях и процессах Core системы. 
Поэтому сложно будет найти подходящее готовое решение - придется писать самим.
Здесь же менеджеры могут проверить любой рандомный заказ [US-160].
### Система поощрения менеджеров через ставки на заказы 
**Связанные US**:
[US-250], [US-262]
Эта система нужна исключительно для того, чтобы все остальное не развалилось.
Мало менеджеров -> меньше проверок качества -> хуже качество работ -> меньше клиентов.
Никакое стороннее решение здесь нельзя применить, так как такой тотализатор в серой зоне [US-262].

Так как это не Core домен, то на разработку этой системы можно потратить меньше времени и не сильно заботиться о качестве. Если система ставок упадет на 1 день или пропустит пару ивентов, то ничего критично не произойдет.
### Интеграция с отделом сборки расходников
**Связанные US**:
[US-130], [US-140]
Отдел сборки расходников наш, поэтому придется делать свою систему внутри отдела для интеграции MCF.
### Система нотификаций
**Связанные US**:
[US-27*]
Отдельный маленький сервис, который будет принимать все ивенты и формировать ивенты.
# Сущности
## Заказы
**Почему отдельная сущность**: 
- У заказа есть отдельный жизненный цикл
**Поля**:
```python
class Order:
	status: Active | Completed | Canceled # Статус: активный, завершенный, отмененный.
	cost: int  # Стоимость
	client: CatTester  # Клиент кот-тестировщик
	assigned_to: CatWorker # Назначенный воркер
	order_type: OrderType # Тип услуги
	description: str
	required_consumables: list[Consumable] # Список необходимых расходников
```

**Примечание**:
- Могут добавиться статусы по сборке расходников, оплате и тд.
## Кандидаты в воркеры
**Почему отдельная сущность**:
У кандидатов в воркеры отдельный жизненный цикл.
В отличие от обычных воркеров:
- Они проходят процессы отбора, назначения характеристик.
  У воркеров все характеристики уже назначены.
- Они никак не взаимодействуют с заказами и котами-тестировщиками - у них нет прав и доступа в систему.
- Информация по ним может быть частично заполненной:
  1) Заполнена только общая информация
  2) Заполнены результаты опроса
  3) Заполнены характеристики

**Поля**:
```python
class Candidate:
	status: Registered | QuizPassed | Approved
	name: str
	perks: list[Perk]  # Список сильных/слабых сторон кандидата
```
## Коты-тестировщики
## Расходники\
Есть жизненный цикл: сформировано, принято подрядчиком, обработано.
**Поля**:
```python
class Consumable:
	for_client: Client  # Для кого
	reason: str # Зачем нужен расходник
	
```
# Общие решения
Команда первое время будет маленькая.
**Reasoning**: меньше коммуникаций и согласований => быстрее разработка и лучше целостность.
# Технические решения
## Модульный монолит для всех Core сервисов
**Reasoning**:
- Команда изначально маленькая => нет рук для формирования всего инструментария для поддержки микросервисов
- При расширении команды возникнет потребность в микросервисах, поэтому монолит модульный.
  С расчетом на то, что модули превратятся в микросервисы.
- На начальном этапе TTM и так будет высокий - не написано ещё много кода. Модульность позволит тестировать быстро гипотезы.
- Нагрузка не будет критичной первое время - 1к заявок в день, 10 заказов в день, 20 воркеров, 100 клиентов.
  К тому же процесс привлечения пользователей - это долгий процесс продаж. 
  После него бизнес увидит метрики и сможет реалистично прогнозировать скорость роста пользователей.
**Модули**:
- Обработка заказов (вместе с подсчетом стоимости)
- 
## Монолит для Admin Panel
**Reasoning**:
- Админка запрашивает данные у микросервисов, а не наоборот => не является bottleneck'ом => масштабирование админки не потребуется.
- Менеджеров немного и не будет много => нагрузка на админку минимальна и масштабирование не требуется.
### Коммуникация
**Синхронная** c сервисами Core-системы (сейчас, с монолитом) через API. *Предположительно, и со всеми остальными частями системы*.
**Reasoning**: 
- Если админка начнет получать ивенты от Core-системы, то на админку падет та же нагрузка. Будет 1к/запросов в секунду на создание заказа в Core - будет и на админку.
  При синхронных запросах по требованию админка не будет сильно нагружена.
  Так как у Core системы RPS больше, чем у админки, синхронные запросы - капля в море.
- Админка по своей сути зависима от сервисов системы (агрегирует все данные внутри), поэтому ничего плохо в том, чтобы синхронного запрашивать у сервисов данные.
  Если сервис заказов упал, админка не должна иметь возможности редактировать заказ или как-то им манипулировать.
### Features
- CRUD для заказов.
- Кнопка "выдано" для сотрудника отдела расходников.
  После нажатия все заказы меняют статус на "готов к выполнению"
## Сервис-адаптер для интеграции с подрядчиком печения
**Предположения**:
- Подрядчик имеет API, по которому можно провести интеграцию.
- Печенье - дополнительный расходник, который не виден коту-тестировщику, но виден воркеру.
- Если клиент не получит печенье - будут большие проблемы у всех
**Reasoning**:
- С подрядчиком печенья коммуникация асинхронная (10 мин доставки [US-150]).
- Если Core-система упала, все процессы с подрядчиком должны продолжаться (запрос на привоз печенья, операции с отделом расходников).
### Коммуникация
Коммуникация `адаптер-подрядчик` **асинхронная**.
**Reasoning**: подрядчик за 10 мин доставляет печенье [US-150]).
Коммуникация `core-адаптер` **асинхронная**. 
**Reasoning**: 

## Что осталось неясно
- [ ] Откуда может возникнуть 1к запросов? 
    Пики бывают только в определенные события (праздники, например), но здесь вроде нет поводов для этого.
    От DDOS есть другие способы защиты (**TODO** какие?).
- [ ] [US-150] А как информация о клиенте будет попадать подрядчику? Нужна интеграция с системой подрядчика или все происходит полностью offline?
- [ ] [US-180] Какая форма? Простая выгрузка в excel или что-то ближе к исторической аналитике? Будут ли интеграции с PowerBI?
- [ ] Как в real-time считать стоимость заказа и не сильно связывать систему подсчета стоимости и обработки заказов?
- [ ] Мобильное приложение будет? Если да, то не только на почту будут уведомления приходить.
- [ ] [US-100] Как характеристики будут определяться? Менеджеры сами будут анализировать информацию или будет система автоматическая?
## Log рассуждений
- Коты автоматически попадают в систему => нужно изначально иметь базу всех клиентов компании. Есть ли она?
- Будет **админка**.
- [US-030]
  Оч странная политика стоимости. Почему в полном объеме
- Скидка определяется от действий юзера в прошлом (сумма покупок).
- Пока вместо матчинга - рандом
  Надо получается изолировать этот домен, чтобы потом подменить.
- [US-080] связь менеджера и кандидата
  В админку надо запихивать это все.
	- [US-081] Нужно в будущем избежать дудоса.
	  Хз пока как. Можно просто изолировать этот сервис, чтобы он не влиял на другие. И как он вообще может влиять?
- [US-090] нужен конфигуратор
- [US-100] Нужен маппинг между входящими котами и принятыми котами. Вроде одинаковые коты, но стадии у них разные. Разные сервисы значит
- [US-110] что значит "не придет на заказ"? Это автоматически определяется как-то?
  Почему вообще клиент должен платить за отмененный не по его поводу заказ?
- [US-140] отдел расходников как-то связан с заказами из MCF. Но в их случае это просто поставить кнопку "выдано". Отдел расходников зависим от MCF.
- [US-150] Интеграция с подрядчиком. Ему надо отправлять всякую инфу. Он будет отправлять расходники
  Приезжает **не сразу, а через 10 мин**.
- [US-160] Менеджеры видят вообще все заказы. Вся информация в одном месте собирается (в админке)
- [US-170] Админка ловит Event об отмене заказа и сразу создает что-то в пуле проверок.
- [US-180] Админка связана с аналитикой. Возможно, она будет как Proxy к ней
- [US-190], [US-200] Интеграция с платежкой видимо
  **Нужно ли хранить у нас все по штрафам и выплатам или можно делегировать?**
- [US-220], [US-230] Надо хранить **историю списаний** и всю аналитику
- [US-240] Менеджер может начислить шекели.
  **Тогда нужно хранить у нас все инвойсы. Но нужно обеспечить безопасность этих операций**.
- [US-260] **Никакой автоматизации и интеграций с банком в ставках**.
  Просто циферки записываем.
- [US-270] Не верю, что только на почту. На мобилку тож могут приходить.
  **Система нотификаций должна быть**.

## Пожелания к системе
- Низкий TTM
  Следовательно, нужна модульность, тк надо много тестировать гипотез.
- Общая нагрузка на систему не будет превышать 10 заказов в день и 100 клиентов. Воркеров будет около 20 котов.
  **Но буквально же** [US-081] говорилось о тысячах.
  Дудос и другими способами можно предотвратить. 
